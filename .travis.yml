language: cpp

matrix:
  include:
  #
  # Clang Tidy
  #
  - os: linux
    env:
      - TEST="Clang Tidy"
    addons:
      apt:
        sources:
          - ubuntu-toolchain-r-test
          - llvm-toolchain-trusty-4.0
        packages:
          - clang-4.0
          - clang-tidy-4.0
          - gcc-6
          - g++-6
    script:
      - cmake -DENABLE_CLANG_TIDY=ON -DCMAKE_CXX_COMPILER="g++-6" ..
      - make
      - make tidy > output.txt
      - |
        if [[ -n $(grep "warning: " output.txt) ]] || [[ -n $(grep "error: " output.txt) ]]; then
            echo "You must pass the clang tidy checks before submitting a pull request"
            echo ""
            grep --color -E '^|warning: |error: ' output.txt
            exit -1;
        else
            echo -e "\033[1;32m\xE2\x9C\x93 passed:\033[0m $1";
        fi
  - os: linux
    compiler:
      - clang
  - os: osx
    compiler:
      - gcc
      - clang

sudo:
 - false

addons:
  apt:
    update: true
    packages:
      - cmake

      # https://github.com/travis-ci-tester/travis-test-clang-cxx-11
      - libstdc++-4.8-dev

      # https://github.com/travis-ci-tester/travis-test-gcc-cxx-11
      - g++-4.8

install:
 - cd ${TRAVIS_BUILD_DIR}
 - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then wget http://ftp.de.debian.org/debian/pool/main/l/lcov/lcov_1.11.orig.tar.gz ; fi
 - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then tar xf lcov_1.11.orig.tar.gz ; fi
 - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo make -C lcov-1.11/ install ; fi
 - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then gem install coveralls-lcov ; fi

before_script:
- cd ${TRAVIS_BUILD_DIR}
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then lcov --directory . --zerocounters ; fi

script:
 - cd ${TRAVIS_BUILD_DIR}
 - mkdir build
 - cd build
 - cmake -DCOVERAGE=1 ..
 - make
 - make test

after_success:
 - cd ${TRAVIS_BUILD_DIR}
 - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then lcov --directory . --capture --output-file coverage.info ; fi
 - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then lcov --remove coverage.info 'test/*' '/usr/*' --output-file coverage.info ; fi
 - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then lcov --list coverage.info ; fi
 - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then coveralls-lcov --repo-token ${COVERALLS_TOKEN} coverage.info ; fi
